{#{% load easy_maps_tags %}#}
{#    <script src="{% static 'js/nodes.js' %}"></script>#}
{#<script>#}
{##}
{##}
{##}
{##}
{##}
{##}
{##}
{#</script>#}
{#    <link rel="stylesheet" href="/maps/documentation/javascript/demos/demos.css">#}

{#   <script type="text/javascript">#}
{##}
{#      var map;#}
{#      function initMap() {#}
{#        map = new google.maps.Map(document.getElementById('map'), {#}
{#          center: {lat: -34.397, lng: 150.644},#}
{#          zoom: 8#}
{#        });#}
{#      }#}
{##}
{##}
{#             //start of modal google map#}
{#      $('#registerModal').on('shown.bs.modal', function () {#}
{#          google.maps.event.trigger(map, "resize");#}
{#          map.setCenter({lat: -34.397, lng: 150.644});#}
{#      });#}
{#    </script>#}





{#jQuery(document).ready(function($) {#}
{#            $(".lloc_entrega_reg").change(function(e){#}
{#                        map = new google.maps.Map(document.getElementById('map'), {#}
{#          center: {lat: -34.397, lng: 150.644},#}
{#          zoom: 8#}
{#        });#}
{##}
{#                    });#}
{#        });#}
{##}
{#    $(".domicili_form").submit(function (e) {#}
{##}
{##}
{#        var dataentrega = document.getElementById("dataentrega");#}
{#	var frequencia = document.getElementById("frequencia");#}
{#	var node = document.getElementById("lloc_entrega");#}
{##}
{#      var data = $(".lloc_entrega").serialize();#}
{##}
{##}
{#    var selectedValue = node.options[node.selectedIndex].value;#}
{#    var selected = {'selectedValue': selectedValue, CSRF: '{{ csrf_token }}'};#}
{##}
{#//{#    changeFunc.preventDefault();#}
{#        e.preventDefault();#}
{#	$.post("/nodecalc/", $(this).serialize(), function(data) {#}
{#        if (data == "OK") {#}
{#            CallNotification("Invitacio a participar a la xarxa enviada amb exit", "success")#}
{#        } else {#}
{#            CallNotification("No es possible convidar aquest correu electronic", "failure")#}
{#        }#}
{#    });#}
{##}
{##}
{##}
{##}
{#    });#}
{##}
{##}
{#</script>#}
{#El div mymodal serveix per tancar comandes a traves d'un dialeg de javascript#}
    <!-- The Modal -->

{#{% if up.lloc_entrega_perfil.pk == "1" %}#}
{#<div id="registerModal" name="registerModal" class="registerModal" style="display: none">#}
{#{% else %}#}
{##}
<div id="registerModal" name="registerModal" class="registerModal" style="display: block">
{#{% endif %}#}

  <!-- Modal content -->
  <div class="reg-modal-content">

{#    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDUirWAP7iFxFp7W1jmhoTrOYzZ-Z2sYZ8&callback=initMap"#}
{#    async defer> </script>#}

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDUirWAP7iFxFp7W1jmhoTrOYzZ-Z2sYZ8&callback=initMap"
    async defer></script>

<script>



      var map;
{#      var polygons = [];#}
      var marker_d;
      function initMap() {

        var mollet = new google.maps.LatLng(41.539064, 2.2130028);
{#        var left_menu = document.getElementById('sidebar-wrapper');#}
{##}
{#        left_menu.hide();#}

        map = new google.maps.Map(document.getElementById('map'), {
          center: mollet,
          zoom: 12,
{#          mapTypeId: 'satellite'#}
        });

          $.post("/allcoordenades/", function(data) {
              var i = 0;
              var marker = [];
              var image = '/static/img/u-pick_stand.png'
              var img_domicili = '/static/img/vespa.png'
              data.forEach( function(arrayItem)
				{
                    var contentString = '<div id="content">'+
                          '<div id="siteNotice">'+
                          '</div>'+
                          '<h1 id="firstHeading" class="firstHeading">Uluru</h1>'+
                          '<div id="bodyContent">'+
                          '<p><b>Uluru</b>, also referred to as <b>Ayers Rock</b>, is a large ' +
                          'sandstone rock formation in the southern part of the '+
                          'Northern Territory, central Australia. It lies 335&#160;km (208&#160;mi) '+
                          'south west of the nearest large town, Alice Springs; 450&#160;km '+
                          '(280&#160;mi) by road. Kata Tjuta and Uluru are the two major '+
                          'features of the Uluru - Kata Tjuta National Park. Uluru is '+
                          'sacred to the Pitjantjatjara and Yankunytjatjara, the '+
                          'Aboriginal people of the area. It has many springs, waterholes, '+
                          'rock caves and ancient paintings. Uluru is listed as a World '+
                          'Heritage Site.</p>'+
                          '<p>Attribution: Uluru, <a href="https://en.wikipedia.org/w/index.php?title=Uluru&oldid=297882194">'+
                          'https://en.wikipedia.org/w/index.php?title=Uluru</a> '+
                          '(last visited June 22, 2009).</p>'+
                          '</div>'+
                          '</div>';

                      var infowindow = new google.maps.InfoWindow({
                        content: contentString
                      });





                    var place = new google.maps.LatLng(arrayItem.Lat, arrayItem.Lng);
                    if (arrayItem.a_domicili == "True"){
                        marker[i] = new google.maps.Marker({
                          position: place,
                          title: "A Domicili",
{#                          style: {float: left},#}
{#                          labelStyle: {opacity: 0.8, padding: 20px},#}
                          map: map,
                          icon: img_domicili
                    });
                    }else{
					    marker[i] = new google.maps.Marker({
                          position: place,
                          title: arrayItem.nom,
{#                          style: {float: left},#}
{#                          labelStyle: {opacity: 0.8, padding: 20px},#}
                          map: map,
                          icon: image
                    });
                        }
                      marker[i].addListener('click', function() {
                        infowindow.open(map, marker[i]);
                      });

					i++;
				});

          });

          // Define the LatLng coordinates for the polygon's path.
{#        var triangleCoords = [#}
{#          {lat: 41.545431, lng: 2.195419},#}
{#          {lat: 41.552119, lng: 2.221884},#}
{#          {lat: 41.536294, lng: 2.227637},#}
{#          {lat: 41.526672, lng: 2.200995}#}
{#        ];#}
{##}
{#        var triangleCoords2 = [#}
{#          {lat: 41.520636, lng: 2.248667},#}
{#          {lat: 41.522171, lng: 2.259459},#}
{#          {lat: 41.517448, lng: 2.261884},#}
{#          {lat: 41.513495, lng: 2.257088}#}
{#        ];#}
{##}
{#        // Construct the polygon.#}
{#          polygons.push(new google.maps.Polygon({#}
{#          paths: triangleCoords,#}
{#          strokeColor: '#FF0000',#}
{#          strokeOpacity: 0,#}
{#          strokeWeight: 2,#}
{#          fillColor: '#FF0000',#}
{#          fillOpacity: 0.15#}
{#        }));#}
{#          polygons[polygons.length-1].setMap(map);#}
{##}
{#          polygons.push(new google.maps.Polygon({#}
{#          paths: triangleCoords2,#}
{#          strokeColor: '#FF0000',#}
{#          strokeOpacity: 0,#}
{#          strokeWeight: 2,#}
{#          fillColor: '#FF0000',#}
{#          fillOpacity: 0.15#}
{#        }));#}
{##}
{##}
{##}
{#        polygons[polygons.length-1].setMap(map);#}


{#        google.maps.event.addListener(map, 'click', function(event) {#}
{#            placeMarker(event.latLng);#}
{# });#}

        map.addListener('click', function(e) {
        placeMarker(e.latLng, map);
});


 }



    function coord() {


        $.post("/coordenades/", $("#lloc_entrega_reg").serializeArray(), function (data) {

            var Lat = data["Lat"];
            var Lng = data["Lng"];
            LatLng = Lat + "," + Lng
            var location = new google.maps.LatLng(Lat, Lng);

            map.setCenter(location);
            map.setZoom(15);

        });
    }
{##}
{#        var llocentrega = document.getElementById('lloc_entrega_reg')    #}
{#        var carrer = document.getElementById('carrer');#}
{#        var numero = document.getElementById('numero');#}
{#        var pis = document.getElementById('pis');#}
{#        var poblacio = document.getElementById('poblacio');#}
{#        //var geopuntx = document.getElementById('geo_punt');#}
{#        var punt_lat = document.getElementById('punt_lat');#}
{#        var punt_lng = document.getElementById('punt_lng');#}
{#        $.post("/domicili/", $("#lloc_entrega_reg").serializeArray(),#}
{#            function (data) {#}
{#                if ( data["a_domicili"] == true){#}
{#                    carrer.readonly = false;#}
{#                    numero.readonly = false;#}
{#                    pis.readonly = false;#}
{#                    poblacio.readonly = false;#}
{#                    punt_lat.readonly = false;#}
{#                    punt_lng.readonly = false;#}
{#                    poblacio.value = data["poblacio"];#}
{#                    lat = data["geopuntx_lat"];#}
{#                    lng = data["geopuntx_lng"];#}
{#                    punt_lat.value = lat;#}
{#                    punt_lng.value = lng;#}
{#                }else{#}
{#                    carrer.readonly = true;#}
{#                    numero.readonly = true;#}
{#                    pis.readonly = true;#}
{#                    poblacio.readonly = true;#}
{#                    punt_lat.readonly = true;#}
{#                    punt_lng.readonly = true;#}
{#                    carrer.value = data["carrer"];#}
{#                    numero.value = data["numero"];#}
{#                    pis.value = data["pis"];#}
{#                    poblacio.value = data["poblacio"];#}
{#                    lat = data["geopuntx_lat"];#}
{#                    lng = data["geopuntx_lng"];#}
{#                    punt_lat.value = lat;#}
{#                    punt_lng.value = lng;#}
{#                    //geopuntx.disabled = true;#}
{#                }#}
{##}
{#                //geopuntx.value = (lat + " , " + lng);#}
{#                //$('#effect').show();#}
{#            });#}
{#    }#}




{#function placeMarker(location, map) {#}
{#    var marker = new google.maps.Marker({#}
{#        position: location,#}
{#        map: map#}
{#    });#}
{# }#}


function placeMarker(location) {

 var punt_lat = document.getElementById("punt_latx");
 var punt_lng = document.getElementById("punt_lngx");

 if (marker_d == null)
 {
   marker_d = new google.maps.Marker({
      position: location,
      map: map
  }); } else {   marker_d.setPosition(location); }


 punt_lat.value = location.lat();
 punt_lng.value = location.lng();
}




//CSRF TOKEN FOR JS


// using jQuery
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
var csrftoken = getCookie('csrftoken');

function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
});






jQuery(document).ready(function($) {



    $(".register_user_form").submit(function(e){
        e.preventDefault();
        $.post("/nodesave/", $(this).serializeArray(), function(data) {



          });


    });

    var llocpk;


    $.post("/nodes_nou_usuari/",function(data){

    var llocentrega = document.getElementById("lloc_entrega_reg");
    var j = 0;
    var carrer = document.getElementById('carrerx');
    var numero = document.getElementById('numerox');
    var pis = document.getElementById('pisx')
    var poblacio = document.getElementById('poblaciox');
    //var geopuntx = document.getElementById('geo_punt');
    var punt_lat = document.getElementById('punt_latx');
    var punt_lng = document.getElementById('punt_lngx');

        data.forEach(function(arrayItem)
        {
            if(arrayItem.selected=="True"){
                s = arrayItem.nom + "/" + arrayItem.poblacio;
                llocentrega.options[j] = new Option(s, arrayItem.pk, false, true);
                llocpk = arrayItem.pk;
                if(arrayItem.a_domicili == true){
                            poblacio.value = arrayItem.poblacio;
							carrer.readOnly = false;
							numero.readOnly = false;
							pis.readOnly = false;
							poblacio.readOnly = true;
                            carrer.value = "";
                            numero.value = "";
                            pis.value = "";
                            punt_lat.value = "";
                            punt_lng.value = "";
{#							punt_lat.readonly = false;#}
{#							punt_lng.readonly = false;#}
						}else{
                            carrer.value = arrayItem.carrer;
                            numero.value = arrayItem.numero;
                            pis.value = arrayItem.pis;
                            poblacio.value = arrayItem.poblacio;
                            lat = arrayItem.punt_lat;
                            lng = arrayItem.punt_lng;
                            punt_lat.value = lat;
                            punt_lng.value = lng;
							carrer.readOnly = true;
							numero.readOnly = true;
							pis.readOnly = true;
							poblacio.readOnly = true;
							punt_lat.readOnly = true;
							punt_lng.readOnly = true;
							//geopuntx.disabled = true;
						}


            }else{
                s = arrayItem.nom + "/" + arrayItem.poblacio;
                llocentrega.options[j] = new Option(s, arrayItem.pk, false, false );
                }
            j++;
        })
    });


    $.post("/horari/", function(data) {
            var acc = document.getElementById('accordionx');
            var j;
            var h;
            var b;
            var t = "";
            var g;
            data.forEach( function (arrayItemx){

                h = arrayItemx.dia;
                g = "<div>"

                arrayItemx.franjes.forEach( function (arrayItem)
                {
                    g = g + "&nbsp;" + arrayItem.inici + "-" + arrayItem.final + "<br/>";
                });
                t = t + h + g + "</div>";

            })

            t = t + "</div>";

            acc.innerHTML = t;
					$( "#accordion" ).accordion( "refresh" );


    })







    $(".lloc_entrega_reg").change(function(e){

        var carrer = document.getElementById('carrerx');
        var numero = document.getElementById('numerox');
        var pis = document.getElementById('pisx');
        var poblacio = document.getElementById('poblaciox');
        //var geopuntx = document.getElementById('geo_punt');
        var punt_lat = document.getElementById('punt_latx');
        var punt_lng = document.getElementById('punt_lngx');
        var freq = document.getElementById('freq');
        $.post("/domicili/", $(this).serializeArray(),
            function (data) {
                if ( data["a_domicili"] == true){
                    carrer.readOnly = false;
                    numero.readOnly = false;
                    pis.readOnly = false;
                    poblacio.readOnly = true;
                    punt_lat.readOnly = false;
                    punt_lng.readOnly = false;
                    poblacio.value = data["poblacio"];
                    carrer.value = "";
                    numero.value = "";
                    pis.value = "";
                    punt_lat.value = "";
                    punt_lng.value = "";
{#                    lat = data["geopuntx_lat"];#}
{#                    lng = data["geopuntx_lng"];#}
{#                    punt_lat.value = lat;#}
{#                    punt_lng.value = lng;#}
                }else{
                    carrer.value = data["carrer"];
                    numero.value = data["numero"];
                    pis.value = data["pis"];
                    poblacio.value = data["poblacio"];
                    lat = data["geopuntx_lat"];
                    lng = data["geopuntx_lng"];
                    punt_lat.value = lat;
                    punt_lng.value = lng;
                    carrer.readOnly = true;
                    numero.readOnly = true;
                    pis.readOnly = true;
                    poblacio.readOnly = true;
                    punt_lat.readOnly = true;
                    punt_lng.readOnly = true;
                    //geopuntx.disabled = true;
                }
                freq.innerHTML = "(" + data["frequencia"] + ")";
                //geopuntx.value = (lat + " , " + lng);
                //$('#effect').show();
            });
        var acc = document.getElementById('accordionx');
        $.post("/horari/", $(this).serializeArray(),
                function (data) {

                    var j;
                    var h;
                    var b;
                    var t = "";
                    var g;
                    data.forEach( function (arrayItemx){

                        h = arrayItemx.dia;
                        g = "<div>"

                        arrayItemx.franjes.forEach( function (arrayItem)
                        {
                            g = g + "&nbsp;" + arrayItem.inici + "-" + arrayItem.final + "<br/>";
                        });
                        t = t + h + g + "</div>";

                    })

                    t = t + "</div>";

                    acc.innerHTML = t;
					$( "#accordion" ).accordion( "refresh" );


            })


    });

{#				$.post("/domicili/", $(this).serializeArray(),#}
{#					function (data) {#}
{#						if ( data["a_domicili"] == true){#}
{#							carrer.disabled = false;#}
{#							numero.disabled = false;#}
{#							pis.disabled = false;#}
{#							poblacio.disabled = false;#}
{#							punt_lat.disabled = false;#}
{#							punt_lng.disabled = false;#}
{#						}else{#}
{#							carrer.disabled = true;#}
{#							numero.disabled = true;#}
{#							pis.disabled = true;#}
{#							poblacio.disabled = true;#}
{#							punt_lat.disabled = true;#}
{#							punt_lng.disabled = true;#}
{#							//geopuntx.disabled = true;#}
{#						}#}
{#						carrer.value = data["carrer"];#}
{#						numero.value = data["numero"];#}
{#						pis.value = data["pis"];#}
{#						poblacio.value = data["poblacio"];#}
{#						lat = data["geopuntx_lat"];#}
{#						lng = data["geopuntx_lng"];#}
{#						punt_lat.value = lat;#}
{#						punt_lng.value = lng;#}
{#						//geopuntx.value = (lat + " , " + lng);#}
{#						//$('#effect').show();#}
{#					});#}




{##}
{#    $(".lloc_entrega_reg").value("2");#}

});




</script>


        <h5><b>NOU USUARI:</b></h5>

        <p>T'hem enviat un email per comprovar el teu correu-e. <br/>
            Ara, si us plau, selecciona el punt a on millor et va trobarnos quan faci falta</p>

       <form method="post" class="register_user_form">
           {% csrf_token %}


        <div class="thumbnail" >

{#            <input type="hidden" id="punt_lat" name="punt_lat" class="punt_lat" />#}
{#            <input type="hidden" id="punt_lng" name="punt_lng" class="punt_lng" />#}

            <label  for="lloc_entrega_reg">Punt de trobada:</label>


            <select id="lloc_entrega_reg" name="lloc_entrega_reg" class="lloc_entrega_reg form-control" onchange="coord()">

                        <option></option>

{#                 {% for lloc in nodes %}#}
{#                        <option value="{{ lloc.pk }}">{{ lloc.nom }} / {{ lloc.poblacio }} </option>#}
{##}
{#               {% endfor %}#}
           </select> </br>




<div id="geodiv" name="geodiv" position="relative" style="float: right; ">

            <div id="map"></div><br/>
                                        <span class="glyphicon glyphicon-map-marker" style="float: right; position:relative;" >

    {#                                    <input type="text"  id="geo_punt" name="geo_punt" value="Lat:{{ object.punt_lat }}/Lng:{{ object.punt_lng }}" disabled/>#}
                                    Coord:    <input type="text" id="punt_latx" style="max-width: 150px; float: right; position: relative" name="punt_latx" class="punt_lat"  placeholder="clica en el mapa (opcional)" />
{#                                    <br/>#}
{#                                        <span class="glyphicon glyphicon-map-marker" >#}
{#                                        </span>#}
                                        <input type="text" id="punt_lngx" name="punt_lngx" style="max-width: 150px; float: right; position: relative" class="punt_lng" placeholder="clica en el mapa (opcional)" /></span>
                                    </div>



<b>Horari:</b><div id="freq" name="freq">({{ frequencia }})</div>
<div id="accordionx" name="accordionx" style="font-family: 'Special Elite', cursive; font-size: medium; ">

</div>
{#                {% endfor %}#}
<br/>


{#                    <div id="effect" style="display: block" class="ui-widget-content ui-corner-all">#}
{#                            <div class="form-group">#}

{#                            </div> #}
                        </br>

                                <label style="font-weight: 500; float: left" for="carrer">Carrer: </label>
                                <input type="text"  id="carrerx" name="carrerx" class="carrerx form-control" style="max-width: 300px;padding-right: 1px" /><br/>
                                <label style="font-weight: 500; float: left" for="numero">Número:</label>
                                <input type="text"  id="numerox" name="numerox" class="numerox form-control" style="max-width: 300px;padding-right: 1px" /><br/>
                                <label style="font-weight: 500; float: left" for="pis">Pis:</label>
                                <input type="text"  id="pisx" name="pisx" class="pisx form-control" style="max-width: 300px;" /><br/>
                                <label style="font-weight: 500; float: left" for="poblacio">Població:</label>
                                <input id="poblaciox"  name="poblaciox" style="max-width: 300px;" class="poblaciox form-control" /><br/><br/>

{#                    </div>#}




            </br>
{#<input id="pac-input" class="controls" type="text" placeholder="Search Box">#}



        </div>



        <button>Entrar</button>

       </form>
  </div>
</div>




